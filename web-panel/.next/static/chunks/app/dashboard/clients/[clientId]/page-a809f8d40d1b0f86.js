(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[236],{6638:function(e,a,t){Promise.resolve().then(t.bind(t,5450))},5450:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return j}});var s=t(7437),n=t(2464),l=t(3496),i=t(9376),r=t(2265),c=t(9116),d=t(1111),m=t(279),o=t(1773),u=t(2397),p=t(8368),g=t(9178),h=t(4226),x=t(7233),v=t(2660),f=t(2252),y=t(8706);async function N(e,a){let t=a.toISOString().split("T")[0];return(await c.Z.get("/api/compliance/daily?clientId=".concat(e,"&date=").concat(t))).data}function j(){var e;let a=(0,y.T)("clients"),t=(0,y.T)("common"),c=(0,i.useParams)(),j=(0,i.useRouter)(),b=c.clientId,[w,I]=(0,r.useState)(new Date),{data:k,isLoading:T,error:D,refetch:C,isRefetching:M}=(0,n.a)({queryKey:["daily-compliance",b,w.toISOString().split("T")[0]],queryFn:()=>N(b,w),refetchInterval:3e4,refetchIntervalInBackground:!0}),O=(0,r.useMemo)(()=>(function(){let e=[];for(let a=6;a>=0;a--){let t=new Date;t.setDate(t.getDate()-a),t.setHours(0,0,0,0),e.push(t)}return e})(),[]),A=(0,l.h)({queries:O.map(e=>({queryKey:["daily-compliance",b,e.toISOString().split("T")[0]],queryFn:()=>N(b,e),enabled:!!k,staleTime:6e4}))}),S=(null==k?void 0:null===(e=k.meals.flatMap(e=>e.items).filter(e=>null!==e.markedAt).sort((e,a)=>e.markedAt&&a.markedAt?new Date(a.markedAt).getTime()-new Date(e.markedAt).getTime():0)[0])||void 0===e?void 0:e.markedAt)||null,P=null==k?void 0:k.meals.map(e=>({mealId:e.mealId,mealType:e.mealType,mealName:e.mealName,compliancePercentage:e.compliancePercentage,items:e.items.map(e=>({mealItemId:e.mealItemId,ingredientId:e.ingredientId,ingredientName:e.ingredientName,isMandatory:e.isMandatory,status:function(e){switch(e){case 1:return"done";case 2:return"skipped";case 3:return"alternative";default:return null}}(e.status),markedAt:e.markedAt,alternativeIngredientId:e.alternativeIngredientId,alternativeIngredientName:e.alternativeIngredientName}))})),Z=(0,r.useMemo)(()=>{let e=A.map((e,a)=>e.data?{date:O[a].toISOString().split("T")[0],compliance:e.data.dailyCompliancePercentage}:null).filter(e=>null!==e);if(0===e.length)return{average:0,bestDay:null,worstDay:null,trend:null,chartData:[]};let a=e.map(e=>e.compliance),t=a.reduce((e,a)=>e+a,0)/a.length,s=e.reduce((e,a)=>a.compliance>e.compliance?a:e),n=e.reduce((e,a)=>a.compliance<e.compliance?a:e),l=null;if(e.length>=6){let e=a.slice(0,3).reduce((e,a)=>e+a,0)/3,t=a.slice(-3).reduce((e,a)=>e+a,0)/3-e;l=2>Math.abs(t)?"stable":t>0?"up":"down"}return{average:t,bestDay:s,worstDay:n,trend:l,chartData:e}},[A,O]),_=(0,y.T)("insights"),q=(0,r.useMemo)(()=>{let e=[];if(Z.average<50&&e.push({type:"warning",title:_("lowCompliance"),message:_("lowComplianceMessage",{percentage:Z.average.toFixed(0)})}),"down"===Z.trend?e.push({type:"warning",title:_("decliningTrend"),message:_("decliningTrendMessage")}):"up"===Z.trend&&e.push({type:"positive",title:_("improvingTrend"),message:_("improvingTrendMessage")}),null==k?void 0:k.meals){let a=k.meals.filter(e=>1===e.mealType).flatMap(e=>e.items).filter(e=>2===e.status&&e.isMandatory).length;a>0&&e.push({type:"info",title:_("breakfastCompliance"),message:_("breakfastComplianceMessage",{count:a})})}return e},[Z,k,_]),E=A.some(e=>e.isLoading);return T?(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsxs)(g.Z,{className:"p-6",children:[(0,s.jsx)(x.O,{className:"h-8 w-48 mb-4"}),(0,s.jsx)(x.O,{className:"h-4 w-32"})]}),(0,s.jsx)("div",{className:"space-y-6",children:[void 0,void 0,void 0].map((e,a)=>(0,s.jsxs)(g.Z,{className:"p-6",children:[(0,s.jsx)(x.O,{className:"h-6 w-32 mb-4"}),(0,s.jsx)("div",{className:"space-y-3",children:[void 0,void 0].map((e,a)=>(0,s.jsx)(x.O,{className:"h-12 w-full"},a))})]},a))})]}):D?(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsxs)(h.z,{variant:"secondary",onClick:()=>j.push("/dashboard/clients"),className:"flex items-center gap-2",children:[(0,s.jsx)(v.Z,{className:"w-4 h-4"}),a("backToClients")]}),(0,s.jsx)(g.Z,{className:"p-12 text-center",children:(0,s.jsxs)("div",{className:"max-w-md mx-auto",children:[(0,s.jsx)("div",{className:"w-16 h-16 rounded-full bg-destructive/10 flex items-center justify-center mx-auto mb-6",children:(0,s.jsx)(f.Z,{className:"w-8 h-8 text-destructive"})}),(0,s.jsx)("h3",{className:"text-lg font-semibold text-foreground mb-2",children:a("failedToLoad")}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground mb-6",children:D instanceof Error?D.message:t("error")}),(0,s.jsx)(h.z,{variant:"primary",onClick:()=>C(),disabled:M,children:t("retry")})]})})]}):k?(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsxs)(h.z,{variant:"secondary",onClick:()=>j.push("/dashboard/clients"),className:"flex items-center gap-2",children:[(0,s.jsx)(v.Z,{className:"w-4 h-4"}),a("backToClients")]}),(0,s.jsx)(d.D,{clientName:k.clientName,selectedDate:w,dailyCompliancePercentage:k.dailyCompliancePercentage,lastActivity:S,onDateChange:e=>{I(e)}}),!E&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,s.jsx)(o.V,{averageCompliance:Z.average,bestDay:Z.bestDay,worstDay:Z.worstDay,trend:Z.trend}),(0,s.jsx)(u.H,{data:Z.chartData})]}),q.length>0&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-foreground",children:a("insights")}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:q.map((e,a)=>(0,s.jsx)(p.L,{type:e.type,title:e.title,message:e.message},a))})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-foreground mb-4",children:a("dailyTimeline")}),P&&P.length>0?(0,s.jsx)(m.f,{meals:P}):(0,s.jsx)(g.Z,{className:"p-12 text-center",children:(0,s.jsx)("p",{className:"text-muted-foreground",children:a("noMealsPlanned")})})]})]}):null}}},function(e){e.O(0,[675,311,464,520,971,117,744],function(){return e(e.s=6638)}),_N_E=e.O()}]);